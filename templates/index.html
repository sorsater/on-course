{% extends "base.html" %}
{% block body %}
    <!-- The main div that content is generated in -->
    <div id="container">
    </div>

<!-- scripts -->
<script type="text/jsx">
/** @jsx React.DOM */

// For each course in the schedule that is selected
class ScheduleItem extends React.Component {
  handleCourseDel(courseCode){
    this.props.handleCourseDel(courseCode);
  }
  render() {
    var color = this.props.course.color;
    console.log("SCHDUEL ITEM COLOR")
    console.log(color)
    var hej = {backgroundColor: color}
    console.log(hej)
    return (
      <div className={ 'course-selected' } style={ hej } onClick={(e) => {
        e.stopPropagation();
        this.handleCourseDel(this.props.course.code)
      }}>
        {this.props.course.code}
      </div>
    )
  }
}

// The schedule that is to the right of the screen
class Schedule extends React.Component {
  constructor(props) {
    super(props);
    this.handleCourseDel = this.handleCourseDel.bind(this);
    this.state = {
      'clickStatus': {
        'p1b1': {'selected': 'scheduleUnselected', 'checked': true},
        'p1b2': {'selected': 'scheduleUnselected', 'checked': true},
        'p1b3': {'selected': 'scheduleUnselected', 'checked': true},
        'p1b4': {'selected': 'scheduleUnselected', 'checked': true},
        'p1none': {'selected': 'scheduleUnselected', 'checked': true},
        'p2b1': {'selected': 'scheduleUnselected', 'checked': true},
        'p2b2': {'selected': 'scheduleUnselected', 'checked': true},
        'p2b3': {'selected': 'scheduleUnselected', 'checked': true},
        'p2b4': {'selected': 'scheduleUnselected', 'checked': true},
        'p2none': {'selected': 'scheduleUnselected', 'checked': true},
      }
    }
  }
  handleCourseDel(code) {
    this.props.handleCourseDel(code);
  }

  handleBlockClick(slot) {
    this.props.handleBlockClick({
      'period': slot['period'],
      'block': slot['block'],
      'checked': this.state.clickStatus[slot['id']].checked,
    });

    var css = (this.state.clickStatus[slot['id']].selected === 'scheduleUnselected') ? 'scheduleSelected' : 'scheduleUnselected';
    var new_clickStatus = this.state.clickStatus;
    new_clickStatus[slot['id']].selected = css;
    new_clickStatus[slot['id']].checked = ! this.state.clickStatus[slot['id']].checked;
    this.setState({
      'clickStatus': new_clickStatus
    })
  }

  render() {

    var p1b1 = [];
    var p1b2 = [];
    var p1b3 = [];
    var p1b4 = [];
    var p1none = [];

    var p2b1 = [];
    var p2b2 = [];
    var p2b3 = [];
    var p2b4 = [];
    var p2none = [];

    var codes = [];
    var courseItem;
    var c;
    for (var i = 0; i < this.props.courses.length; i++) {
      c = this.props.courses[i]
      courseItem = <ScheduleItem
        key={c.code}
        handleCourseDel={this.handleCourseDel}
        course={c}
      />
      codes.push(c.code);
      switch (c.block1) {
        case '1': p1b1.push(courseItem);    break;
        case '2': p1b2.push(courseItem);    break;
        case '3': p1b3.push(courseItem);    break;
        case '4': p1b4.push(courseItem);    break;
        case '-': p1none.push(courseItem);  break;
        default:
      }
      switch (c.block2) {
        case '1': p2b1.push(courseItem);    break;
        case '2': p2b2.push(courseItem);    break;
        case '3': p2b3.push(courseItem);    break;
        case '4': p2b4.push(courseItem);    break;
        case '-': p2none.push(courseItem);  break;
        default:
      }
    };

    var defaultClasses = "col-sm-3 light-grey noborder"
    var slotClasses = "col-sm-3 light-grey potatis"

    return (
      <div>
        <input type='button'
          value={'Ta bort alla'}
          onClick={() => {this.handleCourseDel('all')}}
        />
        <div className="row my-row">
          <div className={defaultClasses}>
            <h5>Block</h5>
          </div>
          <div className={defaultClasses}>
            <h5>Period 1</h5>
          </div>
          <div className={defaultClasses}>
            <h5>Period 2</h5>
          </div>
        </div>
        <div className="row my-row">
          <div className={defaultClasses}>
            1
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p1b1'].selected } onClick={() => {this.handleBlockClick({ 'period': '1', 'block': '1', 'id': 'p1b1'})}}>
            {p1b1}
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p2b1'].selected} onClick={() => {this.handleBlockClick({ 'period': '2', 'block': '1', 'id': 'p2b1'})}}>
            {p2b1}
          </div>
        </div>
        <div className="row my-row">
          <div className={defaultClasses}>
            2
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p1b2'].selected } onClick={() => {this.handleBlockClick({ 'period': '1', 'block': '2', 'id': 'p1b2'})}}>
            {p1b2}
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p2b2'].selected } onClick={() => {this.handleBlockClick({ 'period': '2', 'block': '2', 'id': 'p2b2'})}}>
            {p2b2}
          </div>
        </div>
        <div className="row my-row">
          <div className={defaultClasses}>
            3
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p1b3'].selected } onClick={() => {this.handleBlockClick({ 'period': '1', 'block': '3', 'id': 'p1b3'})}}>
            {p1b3}
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p2b3'].selected } onClick={() => {this.handleBlockClick({ 'period': '2', 'block': '3', 'id': 'p2b3'})}}>
            {p2b3}
          </div>
        </div>
        <div className="row my-row">
          <div className={defaultClasses}>
            4
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p1b4'].selected } onClick={() => {this.handleBlockClick({ 'period': '1', 'block': '4', 'id': 'p1b4'})}}>
            {p1b4}
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p2b4'].selected } onClick={() => {this.handleBlockClick({ 'period': '2', 'block': '4', 'id': 'p2b4'})}}>
            {p2b4}
          </div>
        </div>
        <div className="row my-row">
          <div className={defaultClasses}>
            Ospecifierat
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p1none'].selected } onClick={() => {this.handleBlockClick({ 'period': '1', 'block': '-', 'id': 'p1none'})}}>
            {p1none}
          </div>
          <div className={slotClasses + ' ' + this.state.clickStatus['p2none'].selected } onClick={() => {this.handleBlockClick({ 'period': '2', 'block': '-', 'id': 'p2none'})}}>
            {p2none}
          </div>
        </div>
      </div>
    )
  }
}

// One element for each profile
class ProfileRow extends React.Component {
  constructor(props) {
    super(props);
    this.handleChange = this.handleChange.bind(this);
    var selected = 'profileUnselected'
    if (props.default === true){
      selected = 'profileSelected';
    }
    this.state = {
      'selected': selected,
      'checked': props.default,
    }
  }

  profileCheckbox() {
    this.props.onClick({
      'id': this.props.profile.id,
      'checked': !this.state.checked,
    });
    var css = (this.state.selected === 'profileUnselected') ? 'profileSelected' : 'profileUnselected';
    this.setState({
      'selected': css,
      'checked': !this.state.checked
    });
  }

  handleChange(event) {}

  render() {
    return (
      <div
        className={ "col-sm-3 profileElement" + ' ' + this.state.selected }
        onClick={ this.profileCheckbox.bind(this) }
      >
        <input
          type="checkbox"
          name={ this.props.profile.id }
          checked={ this.state.checked }
          onChange={ this.handleChange }
        />
        { this.props.profile.name }
      </div>
    )
  }
}

// The checkboxes for the different profiles
class Profiles extends React.Component {
  profileCheckbox(id) {
    this.props.profileCheckbox(id);
  }

  render() {
    var profileRows = [];
    var all_courses = {
      'id': -1,
      'name': 'Alla kurser',
    };

    profileRows.push(
      <ProfileRow
        key='all'
        profile={ all_courses }
        default={true}
        onClick={ this.profileCheckbox.bind(this) }
      />
    );

    this.props.profiles.forEach((profile) => {
      profileRows.push(
        <ProfileRow
          key={ profile.id }
          default={false}
          profile={ profile }
          onClick={ this.profileCheckbox.bind(this) }
        />
      );
    });
    var s = { padding: '15px' };
    return (
      <div style={ s }>
        <div className="row white">
          { profileRows }
        </div>
      </div>
    )
  }
};

// One row for each field
class FieldRow extends React.Component {
  render() {
    return(
      <option value={ this.props.field.id }>
        { this.props.field.name }
      </option>
    )
  }
}

// Select the different fields
class Fields extends React.Component {
  onChange(event) {
    this.props.onChange(event.target.value);
  }
  render() {
    var allFields = {
      'id': -1,
      'name': 'Alla omr√•den',
    };

    var fieldRows = []
    fieldRows.push(
      <FieldRow
        key={ -1 }
        field={ allFields }
      />
    );
    this.props.fields.forEach((field) => {
      fieldRows.push(
        <FieldRow
          key={ field.id }
          field={ field }
        />
      );
    });
    return (
      <select onChange={ this.onChange.bind(this) }>
        { fieldRows }
      </select>
    )
  }
}

// The Selected semester
class Semester extends React.Component {
  onChange(event) {
    this.props.onChange(event.target.value);
  }

  render() {
    return (
      <select onChange={ this.onChange.bind(this) }>
        <option name="Alla">Alla</option>
        <option name="7">7</option>
        <option name="8">8</option>
        <option name="9">9</option>
      </select>
    )
  }
}

// One row for each course
class CourseRow extends React.Component {
  addCourse() {
    var c = this.props.course;

    this.props.onClick({
      'code': c.code,
      'semester': c.semester,
      'block1': c.block1,
      'block2': c.block2,
   });
  }
  render() {
    var nameTdStyle = { width: '70%', color: 'white' };
    var normalTdStyle = { width: '8%', color: 'white' };

    return (
      <div className="row row-eq-height course-row" onClick={ this.addCourse.bind(this) }>
        <div className="col-sm-2 course-row">
          <a href="#">{ this.props.course.code }</a>
        </div>
        <div className="col-sm-1 course-row">
          { this.props.course.hp }
        </div>
        <div className="col-sm-1 course-row">
          { this.props.course.level }
        </div>
        <div className="col-sm-1 course-row">
          { this.props.course.semester }
        </div>
        <div className="col-sm-1 course-row">
          { this.props.course.block1 }
        </div>
        <div className="col-sm-1 course-row">
          { this.props.course.block2 }
        </div>
        <div className="col-sm-5 course-row">
          { this.props.course.name }
        </div>
      </div>
    )
  }
}

// The main component
class CourseViewer extends React.Component {
  constructor(props){
    super(props);
    this.handleChangeField = this.handleChangeField.bind(this);
    this.handleChangeSemester = this.handleChangeSemester.bind(this);
    this.handleProfileClick = this.handleProfileClick.bind(this);
    this.handleChangeSearch = this.handleChangeSearch.bind(this);
    this.handleCourseAdd = this.handleCourseAdd.bind(this);
    this.handleCourseDel = this.handleCourseDel.bind(this);
    this.handleBlockClick = this.handleBlockClick.bind(this);

    this.state = {
      selectedField: -1,
      searchString: '',
      courseList: [],
      profileList: [-1],
      period1List: [],
      period2List: [],
      currentField: 'none',
      currentSemester: 'All',
      colors: ["#FF0000", "#FF9900", "#CCFF00", "#33FF00", "#00FF66", "#00FFFF", "#0066FF", "#3300FF", "#CC00FF", "#FF0099"],
      busyColors: [],
    };
  }

  handleChangeField(fieldID) {
    this.setState({
      currentField: fieldID,
      profileList: [-1],
     })
  }

  handleChangeSemester(semester) {
    this.setState({ currentSemester: semester });
  }

  handleProfileClick(profileObj) {
  //  this.setState({ profileList: [] });
    var id = profileObj.id;
    var checked = profileObj.checked;
    if (checked === true) {
      this.setState({ profileList: this.state.profileList.concat([id]) });
    }
    else{
      var array = this.state.profileList;
      var idx = array.indexOf(id);
      array.splice(idx, 1);
      this.setState({ profileList: array });
    }
  }

  handleChangeSearch(event){
    this.setState({ searchString: event.target.value });
  }

  // Adding course to the list
  handleCourseAdd(course) {
    // Makes sure no duplicates are added
    var found = false;
    this.state.courseList.forEach(function(c) {
      if (course.code === c.code){
        found = true;
      }
    });
    if (found === false) {
      console.log('COLORS')
      console.log(this.state.colors);
      course['color'] = this.state.colors[this.state.courseList.length];
      this.setState({ courseList: this.state.courseList.concat([course]) })
    }
  }

  handleCourseDel(courseCode){
    var newCourseList;
    if (courseCode === 'all'){
      newCourseList = [];
    }
    else{
      newCourseList = this.state.courseList.filter(function(course) {
        if (!course.code.match(courseCode)) {
          return true;
        }
      });
    }
    this.setState({ courseList: newCourseList})
  }

  handleBlockClick(blockObj) {
    var period = blockObj.period;
    var block = blockObj.block;
    var checked = blockObj.checked;

    if (checked === true) {
      if (period === '1') {
        this.setState({ period1List: this.state.period1List.concat( [block] ) });
      }
      else if (period === '2') {
        this.setState({ period2List: this.state.period2List.concat( [block] ) });
      }
    }
    else {
      if (period === '1') {
        var array = this.state.period1List;
        var idx = array.indexOf(block);
        array.splice(idx, 1);
        this.setState({ period1List: array});
      }
      else if (period === '2') {
        var array = this.state.period2List;
        var idx = array.indexOf(block);
        array.splice(idx, 1);
        this.setState({ period2List: array});
      }
    }
  }

  render() {
    // Number of courses that match criteria
    var courseCount;

    // Filter profiles from field
    var profiles = this.props.profiles;
    var curField = this.state.currentField;

    profiles = profiles.filter(function(profile) {
      if (profile.fieldID.match(curField)){
        return true;
      }
    });

    // Filter courses that match profil
    var profileList = this.state.profileList;
    var validProfilesCourses = [];
    // Filter out valid courses in profileCourses
    if (profileList.indexOf(-1) === -1){
      this.props.profileCourses.forEach(function(prof) {
        if (profileList.some(pl => pl == prof.profileID)) {
          validProfilesCourses.push(prof.code);
        }
      })
    } else {
      this.props.courses.forEach(function(prof) {
        validProfilesCourses.push(prof.code);
      });
    }
    var profile_courses = [];
    this.props.courses.forEach(function(course) {
      if (validProfilesCourses.some(pl => pl === course.code)){
        profile_courses.push(course);
      }
    });

    // Filter courses that match semester
    var schedule = this.props.schedule;
    var curSem = this.state.currentSemester;
    if (curSem !== 'All'){
      schedule = schedule.filter(function(row) {
        if (row.semester.match(curSem)) {
            return true;
        }
      });
    }

    // Join the courses with schedule and merge properties
    var courses = [];
    for (var c = 0; c < profile_courses.length; c++) {
      for (var s = 0; s < schedule.length; s++) {
        var cour = profile_courses[c];
        var sche = schedule[s];
        if (cour.code == sche.code) {
          courses.push({
            'code': cour.code,
            'name': cour.name,
            'level': cour.level,
            'hp': cour.hp,
            'semester': sche.semester,
            'period': sche.period,
            'block1': sche.block1,
            'block2': sche.block2,
          });
          break;
        }
      }
    }

    // Filter courses that match schedule (period and block)
    var period1 = this.state.period1List;
    var period2 = this.state.period2List;
    if (period1.length > 0 || period2.length > 0){
      var _this = this;
      courses = courses.filter(function(course) {
        if (period1.indexOf(course.block1) > -1 || period2.indexOf(course.block2) > -1){
          return true;
        }
      });
    }

    // Filter the result with the search field
    var searchString = this.state.searchString.trim().toLowerCase();
    if(searchString.length > 0){
      courses = courses.filter(function(course){
        return (course.code + course.name).toLowerCase().match( searchString );
      });
    }

    // Create the actual course row objects
    var courseRows = []
    courses.forEach((course) => {
      courseRows.push(
        <CourseRow
          key={ course.code }
          course={ course }
          onClick={ this.handleCourseAdd.bind(this) }
        />
      );
    })

    courseCount = courses.length;

    var divStyle = {padding: '20px'};
    return (
      <div className="row row-eq-height container-fluid potatis">
        <div className="col-sm-8 grey">
          <div id="select-program">
            Valt program: { this.props.program.name }
          </div>
          <div id="select-field-program">
            Valt huvudomr√•de:
            <Fields
              fields={fields}
              onChange={ this.handleChangeField.bind(this) }
            />
            <br />
            Vald termin:
            <Semester
              onChange={ this.handleChangeSemester.bind(this) }
            />
          </div>
          <Profiles
            field={ this.state.currentField }
            profileCheckbox={ this.handleProfileClick.bind(this) }
            profiles={ profiles }
          />
          <div className={'course-count'}>
            Antal kurser: {courseCount}
          </div>
          <div style={ divStyle }>
            <input id="search" type="text"
              value={ this.state.searchString }
              onChange={ this.handleChangeSearch }
              placeholder="Vad f√•r det lov att vara? üòã"
            />
            { courseRows }
          </div>
        </div>
        <div className="col-sm-4 light-grey">
          <Schedule
            courses={ this.state.courseList }
            handleCourseDel={ this.handleCourseDel }
            handleBlockClick={ this.handleBlockClick }
          />
        </div>
      </div>
    )
  }
}

// Objects generated from the database
var program = {
  "id": "{{ program.id }}",
  "name": "{{ program.name }}",
  "link": "{{ program.link }}",
};

var fields = [
  {% for f in program.fields %}
    {
      "id": "{{ f.id }}",
      "name": "{{ f.name }}",
      "programID": "{{ f.program_id }}",
    },
  {% endfor %}
];

var profiles = [
  {% for field in program.fields %}
    {% for profile in field.profiles %}
      {
        "id": "{{ profile.id }}",
        "name": "{{ profile.name }}",
        "fieldID": "{{ profile.field_id }}",
        "link": "{{ profile.link }}",
      },
    {% endfor %}
  {% endfor %}
];

var schedule = [
  {% for sc in schedule %}
    {
      "id": "{{ sc.id }}",
      "code": "{{ sc.code }}",
      "semester": "{{ sc.semester }}",
      "period": "{{ sc.period }}",
      "block1": "{{ sc.block1 }}",
      "block2": "{{ sc.block2 }}",
    },
  {% endfor %}
];

var courses = [
  {% for pc in program.courses %}
    {
      "code": "{{ pc.course.code }}",
      "hp": "{{ pc.course.hp }}",
      "level": "{{ pc.course.level }}",
      "name": "{{ pc.course.name }}"
    },
  {% endfor %}
];

var profileCourses = [
  {% for field in program.fields %}
    {% for profile in field.profiles %}
      {% for pr_c in profile.courses%}
        {
          "id": "{{ pr_c.id }}",
          "code": "{{ pr_c.course.code }}",
          "profileID": "{{ pr_c.profile_id }}",
          "vof": "{{ pr_c.vof }}",
        },
        {% endfor %}
    {% endfor %}
  {% endfor %}
];

// Sort the courses
// Sort the courses
courses.sort(function(a, b) {
  var a_code = a.code;
  var b_code = b.code;
  if (a_code < b_code){
    return -1;
  }
  if (a_code > b_code){
    return 1;
  }
  return 0;
});

// Render the webpage
ReactDOM.render(
  <CourseViewer
    program={ program }
    fields={ fields }
    courses={ courses }
    profiles={ profiles }
    schedule={ schedule }
    profileCourses= { profileCourses}
  />,
  document.getElementById('container')
);
</script>

{% endblock %}
