{% extends "base.html" %}
{% block body %}
    <!-- The main div that content is generated in -->
    <div id="container">
    </div>

<!-- scripts -->
<script type="text/jsx">
/** @jsx React.DOM */

function courseClick(course){
    console.log("Course clicked: " + course.code);
    console.log(course);
    shoppingCart.push(course);
    console.log(shoppingCart);
    var pos = document.getElementById('ht1b1');
    pos.innerHTML += course.code;
};

class CourseRow extends React.Component{
  addCourse() {
   this.props.onClick(this.props.course.code);
  }
  render() {
    var nameTdStyle = {width: '70%', color: 'white'};
    var normalTdStyle = {width: '8%', color: 'white'};

    return (
      <div className="row row-eq-height course-row" onClick={this.addCourse.bind(this)}>
        <div className="col-sm-2 course-row">
          <a href="#">{this.props.course.code}</a>
        </div>
        <div className="col-sm-1 course-row">
          {this.props.course.hp}
        </div>
        <div className="col-sm-1 course-row">
          {this.props.course.level}
        </div>
        <div className="col-sm-8 course-row">
          {this.props.course.name}
        </div>
      </div>
    )
  }
}

class ProfileRow extends React.Component{
  constructor(props) {
    super(props);
    this.state = {
      'selected': 'profileUnselected',
      'checked': false
    }
  }

  profileCheckbox() {
    this.props.onClick(this.props.profile.id);
    var css = (this.state.selected === 'profileUnselected') ? 'profileSelected' : 'profileUnselected'
    this.setState({
      'selected': css,
      'checked': !this.state.checked
    })
  }

  render() {
    return (
      <div
        className={"col-sm-3 profileElement" + ' ' + this.state.selected}
        onClick={this.profileCheckbox.bind(this)}
      >
        <input
          type="checkbox"
          name={this.props.profile.id}
          checked={this.state.checked}
        />
        {this.props.profile.name}
      </div>
    )
  }
}

class ProfileSelector extends React.Component{
  profileCheckbox(id) {
    console.log('profile checkbox click')
    console.log(id);

    var profile_match = this.props.profiles.filter(function(profile) {
      return (profile.id == id);
    });
    console.log(JSON.stringify(profile_match));
    this.props.profileCheckbox(id);
  }

  render() {
    var profileRows = [];
    var profiles = this.props.profiles

    profiles.forEach((profile) => {
      profileRows.push(<ProfileRow key={profile.id} profile={profile} onClick={this.profileCheckbox.bind(this)}/>);
    });
    var s = {padding: '15px'};
    return (
      <div style={s}>
        <div className="row white">
          {profileRows}
        </div>
      </div>
    )
  }
};

class ScheduleViewer extends React.Component{
  constructor(props) {
    super(props);
  }
  render() {
    return (
      <div>
      {this.props.selectedCourses}
      <div className="row">
        <div className="col-sm-3 light-grey noborder">
          Block
        </div>
        <div className="col-sm-3 light-grey noborder">
          Period 1
        </div>
        <div className="col-sm-3 light-grey noborder">
          Period 2
        </div>
      </div>
      <div className="row">
        <div className="col-sm-3 light-grey noborder">
          1
        </div>
        <div className="col-sm-3 light-grey noborder">
          TDDD27
        </div>
        <div className="col-sm-3 light-grey noborder">
          TDDE01
        </div>
      </div>
      <div className="row">
        <div className="col-sm-3 light-grey noborder">
          2
        </div>
        <div className="col-sm-3 light-grey noborder">
          TATA24
        </div>
        <div className="col-sm-3 light-grey noborder">
          TDDD83
        </div>
      </div>
      <div className="row">
        <div className="col-sm-3 light-grey noborder">
          3
        </div>
        <div className="col-sm-3 light-grey noborder">
          TAEN33
        </div>
        <div className="col-sm-3 light-grey noborder">

        </div>
      </div>
      <div className="row">
        <div className="col-sm-3 light-grey noborder">
          4
        </div>
        <div className="col-sm-3 light-grey noborder">

        </div>
        <div className="col-sm-3 light-grey noborder">
          TAMS27
        </div>
      </div>
      </div>
    )
  }
}

class FieldRow extends React.Component {
  render() {
    return(
      <option value={this.props.field.id}>
        {this.props.field.name}
      </option>
    )
  }

}
class Fields extends React.Component {
  onChange(event) {
    this.props.onChange(event.target.value);
  }
  render() {
    var fieldRows = []
    this.props.fields.forEach((field) => {
      fieldRows.push(<FieldRow key={field.id} field={field}/>);
    });
    return (
      <select onChange={this.onChange.bind(this)}>
        {fieldRows}
      </select>
    )
  }
}

class CourseViewer extends React.Component {
  constructor(props){
    super(props);
    this.handleChangeSearch = this.handleChangeSearch.bind(this);
    this.profileCheckbox = this.profileCheckbox.bind(this);
    this.addCourse = this.addCourse.bind(this);
    this.fieldSelect = this.fieldSelect.bind(this);

    this.state = {
      selectedField: -1,
      searchString: '',
      courseList: [],
      profileList: [],
      currentField: 'none',
    };
  }

  // sets state, triggers render method
  handleChangeSearch(event){
    // Read value form input box
    this.setState({
      searchString: event.target.value
    });
  }

  // Adding course to the list
  addCourse(code) {
    console.log('clicking course', code);
    //this.state.courseList.push(code);
    console.log(this.state.courseList);
    this.setState({
      courseList: this.state.courseList.concat([code])
    })
    console.log(this.state.courseList);
  }

  profileCheckbox(profileID) {
    console.log('handleChangeProfile :) :) ');
    console.log(profileID);
    this.state.profileList.push(profileID);
    console.log(this.state.profileList);
  }

  fieldSelect(fieldID) {
    var fieldName =
      this.props.fields.filter(function(field) {
        return (field.id == fieldID)
      }
    )[0].name;
    console.log("Field selected: " + fieldID + ' ' + fieldName);
    this.setState({ currentField: fieldID })
  }

  render() {
    var courses = this.props.courses;

    var searchString = this.state.searchString.trim().toLowerCase();

    // filter courses list by value from input box
    if(searchString.length > 0){
      courses = courses.filter(function(course){
        return (course.code + course.name).toLowerCase().match( searchString );
      });
    }
    var courseRows = []
    courses.forEach((course) => {
      courseRows.push(<CourseRow key={course.code} course={course}  onClick={this.addCourse.bind(this)}/>);
    })

    var tableStyle = {width: '100%'};
    var divStyle = {padding: '20px'};

    var tableStyleLeft = {width: '70%'}
    var tableStyleRight = {width: '30%'};

    return (
      <div className="row row-eq-height container-fluid potatis">
        <div className="col-sm-8 grey">
          <div id="selectedProgram">
            Valt program: {this.props.program.name}
          </div>
          <div id="selectedField">
            Valt huvudomr√•de:
            <Fields
              fields={fields}
              onChange={this.fieldSelect.bind(this)}
            />
          </div>
          <ProfileSelector
            profileCheckbox={this.profileCheckbox.bind(this)}
            profiles={this.props.profiles}
          />
          <div style={divStyle}>
            <input id="search" type="text"
              value={this.state.searchString}
              onChange={this.handleChangeSearch}
              placeholder="Vad f√•r det lov att vara? üòã"
            />
            {courseRows}
          </div>
        </div>
        <div className="col-sm-4 light-grey">
          <ScheduleViewer
            selectedCourses={this.state.courseList}
          />
        </div>
      </div>
    )
  }
}

// list of courses, defined with JavaScript object literals
var courses = [
  {% for course in courses %}
    {
      "code": "{{ course.code }}",
      "hp": "{{ course.hp }}",
      "level": "{{ course.level }}",
      "name": "{{ course.name }}"
    },
  {% endfor %}
];

var profiles = [
  {% for prof in profiles %}
    {
      "id": "{{ prof.ID }}",
      "name": "{{ prof.name }}",
      "fieldID": "{{ prof.fieldID }}",
      "link": "{{ prof.link }}",
    },
  {% endfor %}
];

var schedule = [
  {% for sc in schedule %}
    {
      "id": "{{ sc.ID }}",
      "code": "{{ sc.code }}",
      "period": "{{ sc.period }}",
      "block1": "{{ sc.block1 }}",
      "block2": "{{ sc.block2 }}",
    },
  {% endfor %}
];

var courseProfiles = [
  {% for cp in course_profiles %}
    {
      "id": "{{ cp.ID }}",
      "code": "{{ cp.code }}",
      "profileID": "{{ cp.profileID }}",
      "vof": "{{ cp.vof }}",
    },
  {% endfor %}
];

var programCourses = [
  {% for pc in program_courses %}
    {
      "id": "{{ pc.ID }}",
      "code": "{{ pc.code }}",
      "programID": "{{ pc.programID }}",
    },
  {% endfor %}
];

var program = [
  {% for p in program %}
    {
      "id": "{{ p.ID }}",
      "name": "{{ p.name }}",
      "link": "{{ p.link }}",
    },
  {% endfor %}
];

var fields = [
  {% for f in fields %}
    {
      "id": "{{ f.ID }}",
      "name": "{{ f.name }}",
      "programID": "{{ f.programID }}",
    },
  {% endfor %}
];

// Filter out courses that belong to certain program
var selectedCourses = [];
courses.forEach(function(c) {
  if (programCourses.some(pc => pc.code == c.code)) {
    selectedCourses.push(c)
  }
});

ReactDOM.render(
  <CourseViewer
    program={ program[0] }
    fields={ fields }
    courses={ selectedCourses }
    profiles={ profiles }
  />,
  document.getElementById('container')
);
</script>

{% endblock %}
